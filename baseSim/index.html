<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Laser Double Slits</title>
    <style>
      body {
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }
      #myCanvas {
        border: 1px solid #7f7f7f;
        background-color: #ffffff;
        width: 90%;
        max-width: 360px;
        aspect-ratio: 0.7;
      }
    </style>
  </head>
  <body>
    <canvas id="myCanvas"></canvas>
    <div>
      <input
        type="range"
        id="slitD"
        name="slitD"
        min="0.5"
        max="4"
        value="2.5"
        step="0.1"
      />
      <label for="slitD">slit spacing</label>
    </div>
    <div>
      <input
        type="range"
        id="freq"
        name="freq"
        min="1.5"
        max="3"
        value="2"
        step="0.01"
      />
      <label for="freq">frequency</label>
    </div>
    <div>
      <input
        type="range"
        id="screenDistance"
        name="screenDistance"
        min="3.0"
        max="7.0"
        value="5.0"
        step="0.1"
      />
      <label for="screenDistance">screen distance</label>
    </div>

    <script>
      // Get the canvas element
      const canvas = document.getElementById("myCanvas");
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;

      // Get the 2D rendering context
      const ctx = canvas.getContext("2d");

      // sizing
      const phyWidth = 7; // in cm.
      const phyHeight = 10; // in cm.
      let ppcm = canvas.width / phyWidth; // ppcm = pixel per centimeter

      // physics
      let slitD = document.getElementById("slitD").value; // spacing
      document.getElementById("slitD").addEventListener("input", () => {
        slitD = document.getElementById("slitD").value;
      });
      const velocity = 0.75; // in cm/s.
      let freq = document.getElementById("freq").value;
      let lambda = velocity / freq;
      document.getElementById("freq").addEventListener("input", () => {
        freq = document.getElementById("freq").value;
        lambda = velocity / freq;
      });
      let screenDistance = document.getElementById("screenDistance").value;
      document
        .getElementById("screenDistance")
        .addEventListener("input", () => {
          screenDistance = document.getElementById("screenDistance").value;
        });
      const slitA = 0.2; // width
      const slitYPos = 1.4;

      // time
      const startTime = Date.now() / 1000;
      let prevTime = startTime;
      let currentTime;
      let deltaTime;

      // coordinate convert function
      function xCon(x) {
        return x + phyWidth / 2;
      }
      function yCon(y) {
        return -y + phyHeight;
      }

      // resize event
      window.addEventListener("resize", () => {
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;
        ppcm = canvas.width / phyWidth; // ppcm = pixel per centimeter
      });

      // animation loop
      function animFrame() {
        requestAnimationFrame(animFrame);
        onEachStep();
      }

      function init() {
        animFrame();
      }

      window.onload = init;

      function onEachStep() {
        // time
        currentTime = Date.now() / 1000;
        elapseTime = currentTime - startTime;
        deltaTime = currentTime - prevTime;
        prevTime = currentTime;

        // clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        drawInWave(); // incoming wave
        drawOutWave(); // outgoing wave
        drawSlit();
        drawScreen();
      }

      function drawSlit() {
        ctx.strokeStyle = "#7f7f7f";
        ctx.lineWidth = 0.2 * ppcm;
        ctx.beginPath();
        ctx.moveTo(xCon(-phyWidth / 2) * ppcm, yCon(slitYPos) * ppcm);
        ctx.lineTo(
          xCon(0 - slitD / 2 - slitA / 2) * ppcm,
          yCon(slitYPos) * ppcm
        );
        ctx.moveTo(
          xCon(0 - slitD / 2 + slitA / 2) * ppcm,
          yCon(slitYPos) * ppcm
        );
        ctx.lineTo(
          xCon(0 + slitD / 2 - slitA / 2) * ppcm,
          yCon(slitYPos) * ppcm
        );
        ctx.moveTo(
          xCon(0 + slitD / 2 + slitA / 2) * ppcm,
          yCon(slitYPos) * ppcm
        );
        ctx.lineTo(xCon(phyWidth / 2) * ppcm, yCon(slitYPos) * ppcm);
        ctx.stroke();
      }

      function drawInWave() {
        // calculate how many wave
        const nWave = Math.ceil(slitYPos / lambda);

        ctx.strokeStyle = frequencyToColor(freq) + "55";
        ctx.lineWidth = 0.04 * ppcm;

        const travelDistance = velocity * elapseTime;
        for (let i = 0; i < nWave; i++) {
          let yPos = (i + 1) * lambda + travelDistance;
          yPos = yPos % (lambda * nWave);
          if (yPos > slitYPos) {
            continue;
          }
          ctx.beginPath();
          ctx.moveTo(xCon(-phyWidth / 2) * ppcm, yCon(yPos) * ppcm);
          ctx.lineTo(xCon(phyWidth / 2) * ppcm, yCon(yPos) * ppcm);
          ctx.stroke();
        }
      }

      function drawOutWave() {
        // calculate how many wave
        const nWave = Math.ceil((1.5 * (phyHeight - slitYPos)) / lambda);

        ctx.strokeStyle = frequencyToColor(freq) + "55";
        ctx.lineWidth = 0.04 * ppcm;

        const travelDistance = velocity * elapseTime;
        for (let i = 0; i < nWave; i++) {
          let radius = (i + 1) * lambda + travelDistance;
          radius = radius % (lambda * nWave);
          if (radius > 1.5 * (phyHeight - slitYPos)) {
            continue;
          }
          // wave 1
          ctx.beginPath();
          ctx.arc(
            xCon(0 - slitD / 2) * ppcm,
            yCon(slitYPos) * ppcm,
            radius * ppcm,
            Math.PI,
            0
          );
          ctx.stroke();
          // wave 2
          ctx.beginPath();
          ctx.arc(
            xCon(0 + slitD / 2) * ppcm,
            yCon(slitYPos) * ppcm,
            radius * ppcm,
            Math.PI,
            0
          );
          ctx.stroke();
        }
      }

      function drawScreen() {
        // draw white area
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.rect(
          0,
          0,
          phyWidth * ppcm,
          (phyHeight - (slitYPos + Number(screenDistance))) * ppcm
        );
        ctx.fill();

        // draw fringes BG
        ctx.fillStyle = "black";
        ctx.beginPath();
        ctx.rect(
          0,
          yCon(slitYPos + Number(screenDistance) + 1.4) * ppcm,
          phyWidth * ppcm,
          1.4 * ppcm
        );
        ctx.fill();

        // draw fringes
        const resolution = canvas.width;
        for (let i = 0; i < resolution; i++) {
          // get x coordinate
          const x = -phyWidth / 2 + (i * phyWidth) / resolution;
          const theta = Math.atan2(x, screenDistance);
          const intensity =
            Math.cos((Math.PI * slitD * Math.sin(theta)) / lambda) ** 2;
          const alphaHex = Math.round(intensity * 255).toString(16);

          ctx.fillStyle = frequencyToColor(freq) + alphaHex;
          ctx.beginPath();
          ctx.rect(
            xCon(x) * ppcm,
            yCon(slitYPos + Number(screenDistance) + 1.4) * ppcm,
            (phyWidth / resolution) * ppcm,
            1.4 * ppcm
          );
          ctx.fill();
        }
      }

      function frequencyToColor(frequency) {
        // The visible spectrum ranges from about 430 THz (red) to 790 THz (violet).
        // This is a simplified model for converting frequency to an RGB color.
        const THz =
          ((frequency - document.getElementById("freq").min) /
            (document.getElementById("freq").max -
              document.getElementById("freq").min)) *
            (790 - 430) +
          430;

        let r = 0,
          g = 0,
          b = 0;
        let name = "Invisible";

        // The mapping is based on wavelength, so we first convert frequency to wavelength.
        // c = 3e8 m/s (speed of light)
        // frequency is in THz (10^12 Hz)
        // wavelength (nm) = (3e8 m/s) / (frequency * 1e12 Hz) * 1e9 nm/m
        // wavelength (nm) = 300,000 / frequency (in THz)
        const wavelength = 300000 / THz;

        if (wavelength >= 370 && wavelength < 440) {
          // Violet
          r = -(wavelength - 440) / (440 - 370);
          g = 0;
          b = 1;
          name = "Violet";
        } else if (wavelength >= 440 && wavelength < 490) {
          // Blue
          r = 0;
          g = (wavelength - 440) / (490 - 440);
          b = 1;
          name = "Blue";
        } else if (wavelength >= 490 && wavelength < 510) {
          // Cyan
          r = 0;
          g = 1;
          b = -(wavelength - 510) / (510 - 490);
          name = "Cyan";
        } else if (wavelength >= 510 && wavelength < 580) {
          // Green
          r = (wavelength - 510) / (580 - 510);
          g = 1;
          b = 0;
          name = "Green";
        } else if (wavelength >= 580 && wavelength < 620) {
          // Yellow
          r = 1;
          g = -(wavelength - 620) / (620 - 580);
          b = 0;
          name = "Yellow";
        } else if (wavelength >= 620 && wavelength < 750) {
          // Red
          r = 1;
          g = 0;
          b = 0;
          name = "Red";
        }

        // For frequencies outside the visible spectrum (infrared, ultraviolet)
        if (wavelength < 370 || wavelength > 750) {
          return { hex: "#000000", name: "Invisible (UV/Infrared)" };
        }

        // Intensity falls off near the edges of the spectrum
        let factor = 1.0;
        if (wavelength >= 370 && wavelength < 420) {
          factor = 0.3 + (0.7 * (wavelength - 370)) / (420 - 370);
        } else if (wavelength >= 700 && wavelength < 750) {
          factor = 0.3 + (0.7 * (750 - wavelength)) / (750 - 700);
        }

        const finalR = Math.round(255 * r * factor);
        const finalG = Math.round(255 * g * factor);
        const finalB = Math.round(255 * b * factor);

        const toHex = (c) => ("0" + c.toString(16)).slice(-2);
        const hex = `#${toHex(finalR)}${toHex(finalG)}${toHex(finalB)}`;

        return hex;
      }
    </script>
  </body>
</html>
